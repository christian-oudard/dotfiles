#!/bin/bash
set -euo pipefail

ITEM_NAME="Seed - bootstrap keys"

# Create directories if needed
mkdir -p ~/.keys ~/.ssh ~/.gnupg

# Download and extract
op document get "$ITEM_NAME" | tar xJvf - -C ~

# Fix permissions
chmod 700 ~/.keys ~/.ssh ~/.gnupg
chmod 600 ~/.ssh/christian_dedekind ~/.ssh/google_compute_engine ~/.ssh/config
find ~/.keys -type f -exec chmod 600 {} +

# Import GPG key
gpg --import ~/.gnupg/git-signing-key.gpg

# Set ultimate trust on our own key (derive fingerprint from the imported file)
FINGERPRINT=$(gpg --show-keys --with-colons ~/.gnupg/git-signing-key.gpg 2>/dev/null | awk -F: '/^fpr:/ {print $10; exit}')
echo "$FINGERPRINT:6:" | gpg --import-ownertrust

# Clean up temp file
rm -f ~/.gnupg/git-signing-key.gpg

echo "Keys restored."
