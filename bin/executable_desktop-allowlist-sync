#!/usr/bin/env python3
"""
Sync desktop file visibility based on an allowlist.

Reads ~/.config/desktop-allowlist and hides all .desktop files not listed
by creating override files with NoDisplay=true in ~/.local/share/applications.
"""

import os
import sys
from pathlib import Path

ALLOWLIST_PATH = Path.home() / ".config" / "desktop-allowlist"
LOCAL_APPS = Path.home() / ".local" / "share" / "applications"
SYSTEM_DIRS = [
    Path("/usr/share/applications"),
    Path("/usr/local/share/applications"),
    Path.home() / ".local" / "share" / "flatpak" / "exports" / "share" / "applications",
    Path("/var/lib/flatpak/exports/share/applications"),
]

OVERRIDE_MARKER = "# desktop-allowlist-override"


def load_allowlist() -> set[str]:
    """Load allowlist, returning set of desktop file basenames (without .desktop)."""
    if not ALLOWLIST_PATH.exists():
        print(f"Error: {ALLOWLIST_PATH} not found", file=sys.stderr)
        print("Create it with one app name per line (without .desktop extension)")
        sys.exit(1)

    allowed = set()
    for line in ALLOWLIST_PATH.read_text().splitlines():
        line = line.strip()
        if line and not line.startswith("#"):
            # Strip .desktop suffix if user included it
            if line.endswith(".desktop"):
                line = line[:-8]
            allowed.add(line)
    return allowed


def find_system_desktop_files() -> set[str]:
    """Find all system .desktop files, returning basenames without extension."""
    desktop_files = set()
    for d in SYSTEM_DIRS:
        if d.exists():
            for f in d.glob("*.desktop"):
                desktop_files.add(f.stem)
    return desktop_files


def is_our_override(path: Path) -> bool:
    """Check if a file is an override we created."""
    try:
        return OVERRIDE_MARKER in path.read_text()
    except:
        return False


def status():
    """Show which local .desktop files are managed vs user-owned."""
    managed = []
    user_owned = []
    for f in sorted(LOCAL_APPS.glob("*.desktop")):
        if is_our_override(f):
            managed.append(f.stem)
        else:
            user_owned.append(f.stem)

    if user_owned:
        print(f"User-owned ({len(user_owned)}):")
        for app in user_owned:
            print(f"  {app}")
    if managed:
        print(f"Managed overrides ({len(managed)}):")
        for app in managed:
            print(f"  {app}")
    if not user_owned and not managed:
        print("No local .desktop files")


def sync(dry_run: bool = False):
    allowed = load_allowlist()
    system_apps = find_system_desktop_files()

    LOCAL_APPS.mkdir(parents=True, exist_ok=True)

    to_hide = system_apps - allowed
    hidden = 0
    restored = 0

    # Create overrides for apps not in allowlist
    for app in sorted(to_hide):
        override_path = LOCAL_APPS / f"{app}.desktop"
        if override_path.exists() and not is_our_override(override_path):
            # User has their own override, don't touch it
            continue
        if not override_path.exists() or not is_our_override(override_path):
            if dry_run:
                print(f"Would hide: {app}")
            else:
                override_path.write_text(f"""{OVERRIDE_MARKER}
[Desktop Entry]
NoDisplay=true
""")
            hidden += 1

    # Remove overrides for apps now in allowlist
    for override in LOCAL_APPS.glob("*.desktop"):
        if is_our_override(override):
            app_name = override.stem
            if app_name in allowed:
                if dry_run:
                    print(f"Would restore: {app_name}")
                else:
                    override.unlink()
                restored += 1

    action = "Would hide" if dry_run else "Hidden"
    print(f"{action}: {hidden} apps, Restored: {restored} apps")
    if dry_run:
        print(f"\nAllowed ({len(allowed)}): {', '.join(sorted(allowed)[:10])}...")


def main():
    if "--help" in sys.argv or "-h" in sys.argv:
        print("Usage: desktop-allowlist-sync [--dry-run|-n] [--status|-s]")
        print("\nHides desktop files not in ~/.config/desktop-allowlist")
        print("\nOptions:")
        print("  --dry-run, -n  Show what would be done without making changes")
        print("  --status, -s   Show which local files are managed vs user-owned")
        sys.exit(0)

    if "--status" in sys.argv or "-s" in sys.argv:
        status()
        sys.exit(0)

    dry_run = "--dry-run" in sys.argv or "-n" in sys.argv
    sync(dry_run=dry_run)


if __name__ == "__main__":
    main()
