#!/bin/bash
set -euo pipefail

ARCHIVE="$HOME/files/backup/seed.tar.xz"
ITEM_NAME="Seed - bootstrap keys"

# Export GPG keys
gpg --export-secret-keys --output ~/.gnupg/git-signing-key.gpg "$(git config user.email)"

# Create tarball.
tar cJf "$ARCHIVE" \
    -C ~ .keys \
    -C ~ .ssh/christian_dedekind .ssh/google_compute_engine .ssh/config \
    -C ~ .gnupg/git-signing-key.gpg

SIZE="$(stat --printf='%s' "$ARCHIVE" | numfmt --to=iec)"
echo "Created $ARCHIVE ($SIZE)"

# Upload to 1Password.
if op document get "$ITEM_NAME" &>/dev/null; then
    op document edit "$ITEM_NAME" "$ARCHIVE"
    echo "Updated '$ITEM_NAME' in 1Password"
else
    op document create "$ARCHIVE" --title "$ITEM_NAME"
    echo "Created '$ITEM_NAME' in 1Password"
fi
