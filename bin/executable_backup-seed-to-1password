#!/bin/bash
set -euo pipefail

ARCHIVE="$HOME/files/backup/seed.tar.xz"
ITEM_NAME="Seed - bootstrap keys"

# Export GPG keys
EMAIL=$(git config user.email) || { echo "Error: git config user.email is not set" >&2; exit 1; }
gpg --export-secret-keys --output ~/.gnupg/git-signing-key.gpg "$EMAIL"

# Create tarball.
tar cJf "$ARCHIVE" \
    -C ~ .keys \
    -C ~ .ssh/christian_dedekind .ssh/google_compute_engine .ssh/config \
    -C ~ .gnupg/git-signing-key.gpg

SIZE="$(stat --printf='%s' "$ARCHIVE" | numfmt --to=iec)"
echo "Created $ARCHIVE ($SIZE)"

# Upload to 1Password.
ITEM_JSON=$(op item get "$ITEM_NAME" --format=json 2>/dev/null) || true
ITEM_ID=$(printf '%s' "$ITEM_JSON" | jq -re '.id' 2>/dev/null) || true
if [[ -n "$ITEM_ID" ]]; then
    op document edit "$ITEM_ID" "$ARCHIVE"
    echo "Updated '$ITEM_NAME' in 1Password"
else
    op document create "$ARCHIVE" --title "$ITEM_NAME"
    echo "Created '$ITEM_NAME' in 1Password"
fi

# Clean up temp files.
rm -f ~/.gnupg/git-signing-key.gpg "$ARCHIVE"
